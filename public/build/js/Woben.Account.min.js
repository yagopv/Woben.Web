var WobenAccount=angular.module("WobenAccount",["ui.router"]);WobenAccount.config(["$stateProvider",function(a){a.state("login",{url:"/login",templateUrl:"/app/templates/account/login.html",controller:"LoginController"}).state("register",{url:"/register",templateUrl:"/app/templates/account/register.html",controller:"RegisterController"}).state("changePassword",{url:"/dashboard/changePassword",templateUrl:"/app/templates/account/changePassword.html",controller:"ChangePasswordController",resolve:{User:["$state","accountService",function(a,b){return b.isUserInRole(["User","Administrator"]).then(function(a){return a},function(){a.go("signin")})}]}}).state("forgetPassword",{url:"/forgetPassword",templateUrl:"/app/templates/account/forgetPassword.html",controller:"ForgetPasswordController"}).state("resetPassword",{url:"/resetPassword?email&code",templateUrl:"/app/templates/account/resetPassword.html",controller:"ResetPasswordController"}).state("deleteAccount",{url:"/dashboard/deleteAccount",templateUrl:"/app/templates/account/deleteAccount.html",controller:"DeleteAccountController",resolve:{User:["$state","accountService",function(a,b){return b.isUserInRole(["User","Administrator"]).then(function(a){return a},function(){a.go("signin")})}]}}).state("confirmAccount",{url:"/dashboard/confirmaccount",templateUrl:"/app/templates/account/confirmAccount.html",controller:"ConfirmAccountController",resolve:{User:["$state","accountService",function(a,b){return b.isUserInRole(["User"]).then(function(a){return a},function(){a.go("signin")})}]}}).state("registrationComplete",{url:"/registrationcomplete",templateUrl:"/app/templates/account/registrationComplete.html"}).state("signin",{url:"/dashboard/signin",controller:"LoginController",templateUrl:"/app/templates/dashboard/signin.html"})}]),WobenAccount.constant("authEndPoint","https://woben.azurewebsites.net"),WobenAccount.factory("accountService",["$http","$q","$window","$rootScope","baseEndPoint",function(a,b,c,d,e){var f=function(a){angular.copy(a,this),this.emailConfirmed=a.emailConfirmed||a.isEmailConfirmed,this.isAuthenticated=a.isAuthenticated||!0},g=function(a,b,d){var e=new f(a);return d&&b&&c.localStorage.setItem("token",b),b&&c.sessionStorage.setItem("token",b),e};return{User:null,login:function(c,f){var h=b.defer(),i=this;return a({method:"POST",url:e+"/token",data:c}).success(function(a){a.roles=a.roles.split(","),i.User=g(a,a.access_token,f),d.$broadcast("woben:authenticated"),h.resolve(a)}).error(function(a){h.reject(a)}),h.promise},logout:function(){var d=b.defer();return a({method:"POST",url:e+"/api/account/logout"}).success(function(a){c.localStorage.clear("token"),c.sessionStorage.clear("token"),c.location="/",d.resolve(a)}).error(function(a){d.reject(a)}),d.promise},register:function(c){var d=b.defer();return a({method:"POST",url:e+"/api/account/register",data:c}).success(function(a){d.resolve(a)}).error(function(a){d.reject(a)}),d.promise},userInfo:function(){var f=b.defer(),h=this;return a({method:"GET",url:e+"/api/account/userinfo"}).success(function(a){h.User=g(a,c.sessionStorage.token,!1),d.$broadcast("woben:authenticated"),f.resolve(a)}).error(function(a){h.User=g({isAuthenticated:!1},null,!1),f.reject(a)}),f.promise},isUserInRole:function(a){var d=this;if(deferred=b.defer(),d.User&&d.User.isAuthenticated&&d.User.roles.length>0)return angular.forEach(d.User.roles,function(b){return-1!=a.indexOf(b)?(deferred.resolve(d.User),deferred.promise):void 0}),deferred.reject("User don´t have permissions"),deferred.promise;var e=c.sessionStorage.token;return!e&&c.localStorage.token&&(c.sessionStorage.token=c.localStorage.token,e=c.localStorage.token),e?(d.userInfo().then(function(b){d.User=g(b,e,!1),angular.forEach(d.User.roles,function(b){-1!=a.indexOf(b)&&deferred.resolve(d.User)}),deferred.reject("User don´t have permissions")},function(){deferred.reject("User don´t have permissions")}),deferred.promise):(deferred.reject("User don´t have permissions"),deferred.promise)},changePassword:function(c,d,f){var g=b.defer(),h=e+"/api/account/changepassword";return a({method:"POST",url:h,data:{oldPassword:c,newPassword:d,confirmPassword:f}}).success(function(a){g.resolve(a)}).error(function(a){g.reject(a)}),g.promise},forgotPassword:function(c){var d=b.defer(),f=e+"/api/account/forgotpassword";return a({method:"POST",url:f,data:{eMail:c}}).success(function(a){d.resolve(a)}).error(function(a){d.reject(a)}),d.promise},resetPassword:function(c,d,f,g){var h=b.defer(),i=e+"/api/account/resetpassword";return a({method:"POST",url:i,data:{email:c,password:d,confirmPassword:f,code:g}}).success(function(a){h.resolve(a)}).error(function(a){h.reject(a)}),h.promise},deleteAccount:function(){var c=b.defer(),d=e+"/api/account/deleteaccount";return a({method:"POST",url:d}).success(function(a){c.resolve(a)}).error(function(a){c.reject(a)}),c.promise},sendConfirmationMail:function(){var c=b.defer(),d=e+"/api/account/resendconfirmationemail";return a({method:"POST",url:d}).success(function(a){c.resolve(a)}).error(function(a){c.reject(a)}),c.promise},initializeAuth:function(){var a=this,b=c.sessionStorage.token;return!b&&c.localStorage.token&&(c.sessionStorage.token=c.localStorage.token,b=c.localStorage.token),b?void a.userInfo().then(function(c){a.User=g(c,b,!1)}):!1}}}]),WobenAccount.controller("ChangePasswordController",["$scope","accountService","$state","errorService",function(a,b,c,d){a.disabled=!1,a.changePassword=function(){a.disabled=!0,b.changePassword(a.oldPassword,a.newPassword,a.confirmPassword).then(function(){a.disabled=!1,a.modelErrors=null,a.oldPassword=null,a.newPassword=null,a.confirmPassword=null,a.changePasswordForm.$setPristine()},function(b){a.modelErrors=d.handleValidationErrors(b),a.disabled=!1})}}]),WobenAccount.controller("ConfirmAccountController",["$scope","accountService","$state","errorService","ngDialog",function(a,b,c,d){a.disabled=!1,a.showEmailSent=!1,a.sendConfirmationMail=function(){a.disabled=!0,a.showEmailSent=!1,b.sendConfirmationMail().then(function(){a.showEmailSent=!0,a.disabled=!1},function(b){a.modelErrors=d.handleAuthenticationErrors(b),a.disabled=!1})}}]),WobenAccount.controller("DeleteAccountController",["$scope","accountService","$state","errorService","ngDialog",function(a,b,c,d,e){a.sureToDelete=function(){a.dialogMessage="¿Seguro que quieres cancelar tu cuenta?",e.open({template:"/app/templates/common/dialogConfirmation.html",scope:a})},a.confirmAction=function(){b.deleteAccount().then(function(){b.logout()},function(b){a.modelErrors=d.handleAuthenticationErrors(b)})}}]),WobenAccount.controller("ForgetPasswordController",["$scope","accountService","$state","errorService",function(a,b,c,d){a.disabled=!0,a.mailSentSuccess=!1,a.sendConfirmationMail=function(){a.disabled=!0,b.forgotPassword(a.email).then(function(){a.disabled=!1,a.email="",a.mailSentSuccess=!0,a.forgetPasswordForm.$setPristine()},function(b){a.modelErrors=d.handleValidationErrors(b),a.disabled=!1})},a.closeInfo=function(){a.mailSentSuccess=!1},a.modelErrors=null,a.disabled=!1}]),WobenAccount.controller("LoginController",["$scope","accountService","$state","errorService",function(a,b,c,d){a.login=function(e){a.disabled=!0,b.login({userName:a.userName,password:a.password,grant_type:"password"},a.rememberMe).then(function(){a.User=b.User,a.disabled=!1,e&&c.go(e)},function(b){a.modelErrors=d.handleAuthenticationErrors(b),a.disabled=!1})},a.rememberMe=!1,a.User=null,a.modelErrors=null,a.disabled=!1}]),WobenAccount.controller("ResetPasswordController",["$scope","accountService","$state","$stateParams","errorService",function(a,b,c,d,e){a.disabled=!0,a.email=d.email,a.code=d.code,a.resetPasswordSuccess=!1,a.resetPassword=function(){a.disabled=!0,b.resetPassword(a.email,a.password,a.confirmPassword,a.code).then(function(){a.disabled=!1,a.resetPasswordSuccess=!0,a.resetPasswordForm.$setPristine()},function(b){a.modelErrors=e.handleAuthenticationErrors(b),a.disabled=!1})},a.closeInfo=function(){a.mailSentSuccess=!1},a.modelErrors=null,a.disabled=!1}]);