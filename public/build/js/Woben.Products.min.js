var WobenProducts=angular.module("WobenProducts",["ui.router","ngDialog"]);WobenProducts.config(["$stateProvider",function(a){a.state("productList",{url:"/dashboard/product/index",controller:"IndexController",templateUrl:"/app/templates/products/productList.html",resolve:{User:["$state","accountService",function(a,b){return b.isUserInRole(["Administrator"]).then(function(a){return a},function(){a.go("signin")})}]}}).state("updateProduct",{url:"/dashboard/product/update/:productId",controller:"UpdateProductController",templateUrl:"/app/templates/products/updateProduct.html",resolve:{User:["$state","accountService",function(a,b){return b.isUserInRole(["Administrator"]).then(function(a){return a},function(){a.go("signin")})}]}}).state("publicProducts",{url:"/products",controller:"PublicProductController",templateUrl:"/app/templates/products/publicProducts.html",resolve:{User:["$state","accountService",function(a,b){return b.isUserInRole(["User","Administrator"]).then(function(a){return a},function(){a.go("login")})}],TypeaheadData:["$state","productService",function(a,b){return b.getAll("$select=Name,Description").then(function(a){return a},function(){a.go("login")})}]}}).state("viewPublicProduct",{url:"/products/:urlCode",controller:"ViewPublicProductController",templateUrl:"/app/templates/products/viewPublicProduct.html",resolve:{User:["$state","accountService",function(a,b){return b.isUserInRole(["User","Administrator"]).then(function(a){return a},function(){a.go("login")})}]}}).state("notificationList",{url:"/dashboard/notification/index",controller:"NotificationListController",templateUrl:"/app/templates/products/notificationList.html",resolve:{User:["$state","accountService",function(a,b){return b.isUserInRole(["Administrator"]).then(function(a){return a},function(){a.go("signin")})}]}})}]),WobenProducts.value("baseEndPoint","https://woben.azurewebsites.net"),WobenProducts.factory("productService",["$http","$q","$cacheFactory","baseEndPoint","$window",function(a,b,c,d){return{getAll:function(c){var e=b.defer();return a({method:"GET",url:d+"/odata/Product"+(c?"?"+c:""),cache:!0}).success(function(a){e.resolve(a)}).error(function(a){e.reject(a)}),e.promise},getById:function(c){var e=b.defer();return a({method:"GET",url:d+"/odata/Product("+c+")"}).success(function(a){e.resolve(a)}).error(function(a){e.reject(a)}),e.promise},add:function(e){var f=b.defer(),g=d+"/odata/Product";return a({method:"POST",url:g,data:e}).success(function(a){c.get("$http").removeAll(),f.resolve(a)}).error(function(a){f.reject(a)}),f.promise},update:function(e){var f=b.defer(),g=d+"/odata/Product("+e.productId+")";return a({method:"PUT",url:g,data:e}).success(function(a){c.get("$http").removeAll(),f.resolve(a)}).error(function(a){f.reject(a)}),f.promise},"delete":function(c){var e=b.defer();return a({method:"DELETE",url:d+"/odata/Product("+c+")"}).success(function(a){e.resolve(a)}).error(function(a){e.reject(a)}),e.promise},deleteImage:function(c){var e=b.defer();return a({method:"DELETE",url:d+"/api/file?filename="+c}).success(function(a){e.resolve(a)}).error(function(a){e.reject(a)}),e.promise}}}]),WobenProducts.factory("categoryService",["$http","$q","baseEndPoint",function(a,b,c){return{getAll:function(d){var e=b.defer();return a({method:"GET",url:c+"/odata/Category"+(d?"?"+d:"")}).success(function(a){e.resolve(a)}).error(function(a){e.reject(a)}),e.promise},getById:function(){var d=b.defer();return a({method:"GET",url:c+"/odata/Category("+productId+")"}).success(function(a){d.resolve(a)}).error(function(a){d.reject(a)}),d.promise},add:function(d){var e=b.defer();return a({method:"POST",url:c+"/odata/Category",data:d}).success(function(a){e.resolve(a)}).error(function(a){e.reject(a)}),e.promise}}}]),WobenProducts.factory("notificationService",["$http","$q","$cacheFactory","baseEndPoint","$window",function(a,b,c,d){return{getAll:function(c){var e=b.defer();return a({method:"GET",url:d+"/odata/Notification"+(c?"?"+c:""),cache:!0}).success(function(a){e.resolve(a)}).error(function(a){e.reject(a)}),e.promise},getById:function(c){var e=b.defer();return a({method:"GET",url:d+"/odata/Notification("+c+")"}).success(function(a){e.resolve(a)}).error(function(a){e.reject(a)}),e.promise},add:function(e){var f=b.defer(),g=d+"/odata/Notification";return a({method:"POST",url:g,data:e}).success(function(a){c.get("$http").removeAll(),f.resolve(a)}).error(function(a){f.reject(a)}),f.promise},update:function(e){var f=b.defer(),g=d+"/odata/Notification("+e.notificationId+")";return a({method:"PUT",url:g,data:e}).success(function(a){c.get("$http").removeAll(),f.resolve(a)}).error(function(a){f.reject(a)}),f.promise},"delete":function(c){var e=b.defer();return a({method:"DELETE",url:d+"/odata/Notification("+c+")"}).success(function(a){e.resolve(a)}).error(function(a){e.reject(a)}),e.promise}}}]),WobenProducts.controller("AddCategoryController",["$scope","categoryService","errorService",function(a,b,c){a.addCategory=function(){a.disabled=!0,b.add({name:a.name,description:a.description}).then(function(b){a.disabled=!1,a.categories.push(b),a.closeThisDialog()},function(b){a.modelErrors=c.handleODataErrors(b),a.disabled=!1})},a.disabled=!1}]),WobenProducts.controller("AddFeatureController",["$scope",function(a){a.addFeature=function(){a.product.features.push({featureId:0,productId:a.product.productId,name:a.feature.name,description:a.feature.description}),a.closeThisDialog()}}]),WobenProducts.controller("AddProductController",["$scope","productService","errorService","ngDialog","$state",function(a,b,c,d,e){a.addProduct=function(){a.disabled=!0,b.add({name:a.name,isPublished:!1}).then(function(b){a.disabled=!1,a.closeThisDialog(),e.go("updateProduct",{productId:b.productId})},function(b){a.modelErrors=c.handleODataErrors(b),a.disabled=!1})},a.disabled=!1}]),WobenProducts.controller("NotificationListController",["$scope","notificationService","errorService","ngDialog",function(a,b,c,d){a.skip=0,a.top=10,a.noMore=!1,a.odataString="$skip="+a.skip+"&$top="+a.top+"&$expand=Product",b.getAll(a.odataString).then(function(b){a.notifications=b,a.skip=a.top},function(b){a.modelErrors=c.handleODataErrors(b)}),a.search=function(){a.skip=0,a.top=10,a.odataString=a.query&&""!=a.query?"$skip="+a.skip+"&$top="+a.top+"&$filter=substringof('"+a.query+"', CreatedBy)or substringof('"+a.query+"', PhoneNumber)or substringof('"+a.query+"', Text)&$expand=Product&$orderby=CreatedDate desc":"$skip="+a.skip+"&$top="+a.top+"&$expand=Product",b.getAll(a.odataString).then(function(b){a.noMore=!1,a.notifications=b,a.skip=a.top},function(b){a.modelErrors=c.handleODataErrors(b)})},a.loadMore=function(){a.odataString="$skip="+a.skip+"&$top="+a.top+"&$expand=Product",b.getAll(a.odataString).then(function(b){b.length>0&&angular.forEach(b,function(b){a.notifications.push(b)}),b.length<a.top&&(a.noMore=!0),a.skip=a.skip+a.top},function(b){a.modelErrors=c.handleODataErrors(b)})},a.sureToDelete=function(b){a.notificationToDelete=b,a.dialogMessage="¿Seguro que quieres eliminar esta notificación?",d.open({template:"/app/templates/common/dialogConfirmation.html",scope:a})},a.confirmAction=function(){b.delete(a.notificationToDelete.notificationId).then(function(){var b=a.notifications.indexOf(a.notificationToDelete);a.notifications.splice(b,1)},function(b){a.modelErrors=c.handleODataErrors(b)})},a.checkNotification=function(b){a.notificationDetail=b,d.open({template:"/app/templates/products/notificationDetail.html",scope:a})}}]),WobenProducts.controller("IndexController",["$scope","$filter","productService","errorService","ngDialog",function(a,b,c,d,e){a.skip=0,a.top=10,a.noMore=!1,a.odataString="$skip="+a.skip+"&$top="+a.top+"&$orderby=UpdatedDate desc",c.getAll(a.odataString).then(function(b){a.products=b,a.skip=a.top},function(b){a.modelErrors=d.handleODataErrors(b)}),a.search=function(){a.skip=0,a.top=10,a.odataString=a.query&&""!=a.query?"$skip="+a.skip+"&$top="+a.top+"&$filter=substringof('"+a.query+"', Name)or substringof('"+a.query+"', Description)or substringof('"+a.query+"', Markdown)&$orderby=UpdatedDate desc":"$skip="+a.skip+"&$top="+a.top+"&$orderby=UpdatedDate desc",c.getAll(a.odataString).then(function(b){a.noMore=!1,a.products=b,a.skip=a.top},function(b){a.modelErrors=d.handleODataErrors(b)})},a.loadMore=function(){a.odataString="$skip="+a.skip+"&$top="+a.top+"&$orderby=UpdatedDate desc",c.getAll(a.odataString).then(function(b){b.length>0&&angular.forEach(b,function(b){a.products.push(b)}),b.length<a.top&&(a.noMore=!0),a.skip=a.skip+a.top},function(b){a.modelErrors=d.handleODataErrors(b)})},a.sureToDelete=function(b){a.selectedProduct=b,a.dialogMessage="¿Seguro que quieres eliminar este producto?",e.open({template:"/app/templates/common/dialogConfirmation.html",scope:a})},a.confirmAction=function(){c.delete(a.selectedProduct.productId).then(function(){var b=a.products.indexOf(a.selectedProduct);a.products.splice(b,1)},function(b){a.modelErrors=d.handleODataErrors(b)})},a.addProduct=function(){e.open({template:"/app/templates/products/addProduct.html",controller:"AddProductController",scope:a})}}]),WobenProducts.controller("PublicProductController",["$scope","categoryService","productService","utilsService","errorService","baseEndPoint","TypeaheadData","$state",function(a,b,c,d,e,f,g,h){a.skip=0,a.top=6,a.noMore=!1,a.odataString="$skip="+a.skip+"&$top="+a.top+"&$orderby=UpdatedDate desc&$expand=Category",a.searchModel="";var i=new Bloodhound({datumTokenizer:function(a){return Bloodhound.tokenizers.whitespace(a.name)},queryTokenizer:Bloodhound.tokenizers.whitespace,local:g});i.initialize(),a.searchOptions={highlight:!0},a.searchData={displayKey:"name",source:i.ttAdapter()},b.getAll().then(function(b){a.categories=b},function(b){a.modelErrors=e.handleODataErrors(b)}),c.getAll(a.odataString).then(function(b){a.noMore=!1,a.products=b,a.skip=a.top,d.addDummyProduct(a.products,a.products.length),a.pagedProducts=d.groupToPages(a.products,3)},function(b){a.modelErrors=e.handleODataErrors(b)}),a.search=function(){a.skip=0,a.top=6,a.odataString="$skip="+a.skip+"&$top="+a.top+"&$filter=substringof('"+a.searchModel+"', Name) or substringof('"+a.searchModel+"', Description) or substringof('"+a.searchModel+"', Markdown)&$orderby=UpdatedDate desc&$expand=Category",c.getAll(a.odataString).then(function(b){a.products=b,a.noMore=b.length<a.top?!0:!1,a.skip=a.top,d.addDummyProduct(a.products,a.products.length),a.pagedProducts=d.groupToPages(a.products,3)},function(b){a.modelErrors=e.handleODataErrors(b)})},a.loadMore=function(){a.odataString="$skip="+a.skip+"&$top="+a.top+"&$filter=(substringof('"+a.searchModel+"', Name) or substringof('"+a.searchModel+"', Description) or substringof('"+a.searchModel+"', Markdown)"+(a.selectedCategoryId?") and CategoryId eq "+a.selectedCategoryId:")")+"&$orderby=UpdatedDate desc&$expand=Category",c.getAll(a.odataString).then(function(b){angular.forEach(b,function(b){a.products.push(b)}),b.length<a.top&&(a.noMore=!0),a.skip=a.skip+a.top,d.addDummyProduct(a.products,a.products.length),a.pagedProducts=d.groupToPages(a.products,3)},function(b){a.modelErrors=e.handleODataErrors(b)})},a.filterByCategory=function(b){a.skip=0,a.top=6,a.odataString="$skip="+a.skip+"&$top="+a.top+"&$filter=(substringof('"+a.searchModel+"', Name) or substringof('"+a.searchModel+"', Description) or substringof('"+a.searchModel+"', Markdown)) and CategoryId eq "+b+"&$orderby=UpdatedDate desc&$expand=Category",c.getAll(a.odataString).then(function(c){a.products=c,a.noMore=c.length<a.top?!0:!1,d.addDummyProduct(a.products,a.products.length),a.pagedProducts=d.groupToPages(a.products,3),a.selectedCategoryId=b},function(b){a.modelErrors=e.handleODataErrors(b)})},a.navigateToDetail=function(a){h.go("viewPublicProduct",{urlCode:a.urlCodeReference})}}]),WobenProducts.controller("UpdateProductController",["$scope","productService","errorService","categoryService","ngDialog","$sce","$stateParams","$q","baseEndPoint","$timeout",function(a,b,c,d,e,f,g,h,i,j){function k(a){var b=document.getElementById("preview-frame").contentWindow;a&&b.angular&&(a.html=marked(a.markdown?a.markdown:""),b.angular.element("#product-view").scope().updatePreviewData(a))}function l(){$(".tagsinput").tagsInput({onChange:function(){$("input[name=tagsinput]").trigger("input")},onAddTag:function(b){a.product.tags.push({tagId:0,name:b,productId:a.product.productId})},onRemoveTag:function(b){angular.isArray(a.product.tags)&&angular.forEach(a.product.tags,function(c,d){c.name==b&&(c.tagId>0?c.tagId=-1:a.product.tags.splice(d,1))})}}),$(".tagsinput").importTags(a.tags)}a.tags="",a.updateProduct=function(){a.disabled=!0,a.product.html=marked(a.product.markdown?a.product.markdown:""),a.product.category=null,b.update(a.product).then(function(){b.getAll("$filter=ProductId eq "+g.productId+"&$expand=Tags,Features,Category").then(function(b){a.disabled=!1,a.product=b[0];var c=[];angular.isArray(a.product.tags)?(angular.forEach(a.product.tags,function(b,d){c.push(a.product.tags[d.toString()].name)}),a.tags=c.toString(),$(".tagsinput").importTags(a.tags)):a.product.tags={},a.tagMaxIndex||(a.tagMaxIndex="0")},function(b){a.modelErrors=c.handleODataErrors(b),a.disabled=!1})},function(b){a.modelErrors=c.handleODataErrors(b),a.disabled=!1})},h.all([b.getAll("$filter=ProductId eq "+g.productId+"&$expand=Tags,Features,Category"),d.getAll()]).then(function(b){a.product=b[0][0],a.categories=b[1];var c=[];angular.isArray(a.product.tags)?(angular.forEach(a.product.tags,function(b,d){c.push(a.product.tags[d].name)}),a.tags=c.toString(),l()):a.product.tags={},a.tagMaxIndex||(a.tagMaxIndex="0"),j(function(){k(a.product)},5e3)},function(b){a.modelErrors=c.handleODataErrors(b)}),a.addCategoryDialog=function(){e.open({template:"/app/templates/products/addCategory.html",controller:"AddCategoryController",scope:a})},a.disabled=!1,a.previewHtml=!1,a.uploadedFiles=[],a.$watch("uploadedFiles",function(b){b&&b[0]&&(a.product.imageUrl=i+b[0].url)}),a.togglePreview=function(){a.trustedHtml=f.trustAsHtml(marked(a.product.markdown?a.product.markdown:"")),a.previewHtml=!a.previewHtml},a.$watch("product",function(a){k(a)},!0),a.addFeature=function(){e.open({template:"/app/templates/products/addFeature.html",controller:"AddFeatureController",scope:a})},a.deleteFeature=function(b){var c=angular.copy(a.product.features);angular.isArray(c)&&angular.forEach(c,function(c,d){c.name==b.name&&(c.featureId>0?a.product.features[d].featureId=-1:0==c.featureId&&a.product.features.splice(d,1))})}}]),WobenProducts.controller("ViewPublicProductController",["$scope","$stateParams","productService","notificationService","errorService","$window","$sce","accountService","ngDialog",function(a,b,c,d,e,f,g,h,i){function j(){d.add(a.notification).then(function(){a.showNotificationMessage=!0},function(b){a.notificationModelErrors=e.handleODataErrors(b)})}a.User=h.User,a.notification={},a.notification.bestTimeToCall="I","preview"!=b.urlCode&&c.getAll("$expand=Category,Tags,Features&$filter=UrlCodeReference eq '"+b.urlCode+"'").then(function(b){a.product=b[0],a.notification.productId=a.product.productId,a.product.html&&(a.trustedHtml=g.trustAsHtml(a.product.html)),startupKit.uiKitBlog.blog1()},function(b){a.modelErrors=e.handleODataErrors(b)}),a.sendNotification=function(){a.notification.phoneNumber?j():(a.dialogMessage="No has dejado ningún teléfono, te contactaremos por mail. ¿Quieres continuar?",i.open({template:"/app/templates/common/dialogConfirmation.html",scope:a}))},a.confirmAction=function(){j()},a.showNotificationMessage=!1,a.$watch("notification",function(){a.showNotificationMessage=!1},!0),a.sendAnotherMessage=function(){a.showNotificationMessage=!1,a.notification={},a.notification.bestTimeToCall="I",a.notification.productId=a.product.productId},a.updatePreviewData=function(b){b.html&&(a.trustedHtml=g.trustAsHtml(b.html)),a.$apply(function(){a.product=b})}}]);